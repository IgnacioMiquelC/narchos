#!/bin/bash

# Exit early if we don't have the tte show
if ! command -v tte &>/dev/null; then
  exit 1
fi

# Exit early if screensaver is already running
if hyprctl clients -j | jq -e '.[] | select((.class=="Screensaver") or (.title=="Screensaver"))' &>/dev/null; then
  exit 0
fi

# Allow screensaver to be turned off but also force started
if [[ -f ~/.local/state/narchos/toggles/screensaver-off ]] && [[ $1 != "force" ]]; then
  exit 1
fi

focused=$(hyprctl monitors -j | jq -r '.[] | select(.focused == true).name')

for monitor in $(hyprctl monitors -j | jq -r '.[] | .name'); do
  hyprctl dispatch focusmonitor "$monitor"

  case $TERMINAL in
    kitty)
      hyprctl dispatch exec -- \
        kitty --class Screensaver --title Screensaver \
        --config ~/.config/kitty/screensaver.conf \
        narchos-cmd-screensaver
      ;;
    alacritty)
      hyprctl dispatch exec -- \
        alacritty --class Screensaver \
        --config-file ~/.local/share/narchos/default/alacritty/screensaver.toml \
        -e narchos-cmd-screensaver
      ;;
  esac
done

hyprctl dispatch focusmonitor "$focused"

#!/bin/bash

screensaver_in_focus() {
  hyprctl activewindow -j | jq -e '.class == "Screensaver"' >/dev/null 2>&1
}

exit_screensaver() {
  narchos-close-screensaver
  exit 0
}

trap exit_screensaver SIGINT SIGTERM SIGHUP SIGQUIT

# Open the controlling TTY for reliable key detection even if stdin is altered
exec 3</dev/tty

hyprctl keyword cursor:invisible true

mapfile -t EFFECTS < <(tte 2>&1 | grep -oP '{\K[^}]+' | tr ',' ' ' | tr ' ' '\n' | sed -n '/^beams$/,$p' | sort -u)

# Default effect is beams
if ! [ ${#EFFECTS[@]} -gt 0 ]; then
  effect="beams"
fi

while true; do
  effect="${EFFECTS[RANDOM % ${#EFFECTS[@]}]}"
  tte -i ~/.config/narchos/branding/screensaver.txt \
    --frame-rate 60 \
    --canvas-width 0 \
    --canvas-height $(($(tput lines))) \
    --anchor-canvas c \
    --anchor-text c \
    "$effect" &
    tte_pid=$!

  while kill -0 "$tte_pid" 2>/dev/null; do
    # Non-blocking keypress check (exit on Escape key)
    if read -u 3 -rsn1 -t 0.1 key; then
      if [[ "$key" == $'\e' ]]; then
        exit_screensaver
      fi
    fi
    # Short sleep to avoid busy loop and ensure quick reaction when tte exits
    sleep 0.05
  done
done
